#cloud-config
# Copyright 2025 Replicated, Inc.
#
# This cloud-init configuration is used to initialize the primary
# Replicated Embedded Cluster controller node on first boot.

write_files:
  - path: /etc/replicated/license.yaml
    owner: root:root
    permissions: '0600'
    content: |
      ${indent(6, replicated_license_file)}

  - path: /usr/local/bin/install-embedded-cluster.sh
    owner: root:root
    permissions: '0755'
    content: |
      #!/bin/bash
      set -euo pipefail

      # Wait for time sync
      echo "[$(date)] Waiting for time synchronization..." | tee -a /var/log/embedded-cluster-install.log
      while true; do
        if timedatectl show -p NTPSynchronized --value 2>/dev/null | grep -q yes; then
          echo "[$(date)] Time is synchronized!" | tee -a /var/log/embedded-cluster-install.log
          break
        fi
        echo "[$(date)] Not synchronized yet... retrying in 2 seconds." | tee -a /var/log/embedded-cluster-install.log
        sleep 2
      done

      # Admin password is provided via template variable (not logged)
      ADMIN_PASSWORD="${admin_console_password}"

      # Log start of installation
      echo "[$(date)] Starting Embedded Cluster installation..." | tee -a /var/log/embedded-cluster-install.log

      # Change to the directory containing the installer
      cd /var/lib/${replicated_app_slug}

      # Run the installation (avoid logging password)
      echo "[$(date)] Running installation with ${replicated_app_slug} binary..." | tee -a /var/log/embedded-cluster-install.log
      sudo ./${replicated_app_slug} install \
        --license /etc/replicated/license.yaml \
        --admin-console-password "$ADMIN_PASSWORD" \
        --airgap-bundle ${replicated_app_slug}.airgap 2>&1 | grep -v "password" | tee -a /var/log/embedded-cluster-install.log || true

      echo "[$(date)] Installation complete!" | tee -a /var/log/embedded-cluster-install.log

      # Get external IP for logging
      EXTERNAL_IP=$(curl -s http://metadata.google.internal/computeMetadata/v1/instance/network-interfaces/0/access-configs/0/external-ip -H 'Metadata-Flavor: Google' 2>/dev/null || echo "no-external-ip")
      INTERNAL_IP=$(curl -s http://metadata.google.internal/computeMetadata/v1/instance/network-interfaces/0/ip -H 'Metadata-Flavor: Google' 2>/dev/null || echo "unknown")

      echo "[$(date)] Primary controller initialized!" | tee -a /var/log/embedded-cluster-install.log
      echo "[$(date)] Internal IP: $INTERNAL_IP" | tee -a /var/log/embedded-cluster-install.log

      if [ "$EXTERNAL_IP" != "no-external-ip" ]; then
        echo "[$(date)] Access admin console at: https://$EXTERNAL_IP:30000" | tee -a /var/log/embedded-cluster-install.log
      else
        echo "[$(date)] Access admin console at: https://$INTERNAL_IP:30000" | tee -a /var/log/embedded-cluster-install.log
      fi

runcmd:
  - 'echo "[$(date)] Starting Replicated Embedded Cluster Primary Controller initialization..." | tee /var/log/embedded-cluster-init.log'
  - 'echo "App: ${replicated_app_slug}" | tee -a /var/log/embedded-cluster-init.log'
  - 'echo "Channel: ${replicated_channel_slug}" | tee -a /var/log/embedded-cluster-init.log'
  - 'echo "License file written to /etc/replicated/license.yaml" | tee -a /var/log/embedded-cluster-init.log'
  - /usr/local/bin/install-embedded-cluster.sh

final_message: |
  Replicated Embedded Cluster Primary Controller installation complete!

  Access the admin console at: https://[INSTANCE_IP]:30000

  To get the admin console password:
  gcloud secrets versions access latest --secret="${deployment_name}-admin-password" --project="${project_id}"

  To check installation logs:
  sudo tail -f /var/log/embedded-cluster-install.log
